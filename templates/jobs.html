{% extends "base.html" %} 
{% block title %}Job Management{% endblock %} 
{% block content %}

<!-- Statistics Dashboard -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card bg-primary text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-title">Total Jobs</h6>
            <h3 class="mb-0">{{ jobs|length if jobs else 0 }}</h3>
          </div>
          <div class="opacity-75">
            <i class="fas fa-briefcase fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card bg-success text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-title">Total Revenue</h6>
            <h3 class="mb-0">
              ${{ "{:,.2f}".format(jobs|selectattr('final_price')|map(attribute='final_price')|sum) if jobs else "0.00" }}
            </h3>
          </div>
          <div class="opacity-75">
            <i class="fas fa-dollar-sign fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card bg-warning text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-title">Pending Quotes</h6>
            <h3 class="mb-0">{{ jobs|rejectattr('final_price')|list|length if jobs else 0 }}</h3>
          </div>
          <div class="opacity-75">
            <i class="fas fa-clock fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card bg-danger text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-title">Urgent Jobs</h6>
            <h3 class="mb-0">
              {% set urgent_count = 0 %}
              {% if jobs %}
                {% for job in jobs %}
                  {% if job.hard_deadline %}
                    {% set urgent_count = urgent_count + 1 %}
                  {% endif %}
                {% endfor %}
              {% endif %}
              {{ urgent_count }}
            </h3>
          </div>
          <div class="opacity-75">
            <i class="fas fa-exclamation-triangle fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Page Header with Search and Filter -->
<div class="row mb-4">
  <div class="col-md-6">
    <h1 class="display-6 mb-0">
      <i class="fas fa-briefcase text-primary"></i> Job Management
    </h1>
    <p class="text-muted">Manage all your cabinet projects</p>
  </div>
  <div class="col-md-6">
    <div class="d-flex gap-2 justify-content-end">
      <a href="{{ url_for('home') }}" class="btn btn-outline-secondary">
        <i class="fas fa-plus"></i> New Job
      </a>
      <button class="btn btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#filterPanel">
        <i class="fas fa-filter"></i> Filters
      </button>
    </div>
  </div>
</div>

<!-- Search and Filter Panel -->
<div class="collapse mb-4" id="filterPanel">
  <div class="card">
    <div class="card-body">
      <div class="row">
        <div class="col-md-4">
          <label class="form-label">Search Jobs</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" id="searchInput" class="form-control" placeholder="Client name or job ID...">
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Status Filter</label>
          <select id="statusFilter" class="form-select">
            <option value="">All Status</option>
            <option value="draft">Draft</option>
            <option value="quoted">Quoted</option>
            <option value="in-progress">In Progress</option>
            <option value="completed">Completed</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Price Range</label>
          <select id="priceFilter" class="form-select">
            <option value="">All Prices</option>
            <option value="0-1000">$0 - $1,000</option>
            <option value="1000-5000">$1,000 - $5,000</option>
            <option value="5000-10000">$5,000 - $10,000</option>
            <option value="10000+">$10,000+</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">&nbsp;</label>
          <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
            <i class="fas fa-times"></i> Clear
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Jobs Grid -->
<div class="row" id="jobsContainer">
  {% if jobs %}
    {% for job in jobs %}
    <div class="col-lg-6 col-xl-4 mb-4 job-card" 
         data-client="{{ (job.client_name or 'unnamed')|lower }}" 
         data-price="{{ job.final_price or 0 }}"
         data-status="{{ job.status or 'draft' }}">
      <div class="card h-100 shadow-sm">
        <!-- Card Header with Status -->
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="card-title mb-0 text-truncate">
            <i class="fas fa-user-tie text-muted me-1"></i>
            {{ job.client_name or "Unnamed Client" }}
          </h6>
          {% set status = job.status or 'draft' %}
          {% if status == 'draft' %}
            <span class="badge bg-secondary">Draft</span>
          {% elif status == 'quoted' %}
            <span class="badge bg-success">Quoted</span>
          {% elif status == 'in_progress' %}
            <span class="badge bg-primary">In Progress</span>
          {% elif status == 'completed' %}
            <span class="badge bg-success">Completed</span>
          {% elif status == 'cancelled' %}
            <span class="badge bg-danger">Cancelled</span>
          {% else %}
            <span class="badge bg-secondary">{{ status.replace('_', ' ').title() }}</span>
          {% endif %}
        </div>
        
        <!-- Card Body -->
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-12">
              <small class="text-muted d-block">
                <i class="fas fa-calendar-plus"></i>
                Created: 
                {% if job.created_at %}
                  {% if job.created_at.strftime %}
                    {{ job.created_at.strftime('%m/%d/%Y') }}
                  {% else %}
                    {{ job.created_at }}
                  {% endif %}
                {% else %}
                  N/A
                {% endif %}
              </small>
            </div>
          </div>
          
          <!-- Price Information -->
          <div class="row mb-3">
            <div class="col-12">
              {% if job.final_price %}
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-muted">Final Price:</span>
                  <span class="h5 text-success mb-0">${{ job.final_price }}</span>
                </div>
              {% else %}
                <div class="text-center py-2">
                  <span class="badge bg-warning text-dark">
                    <i class="fas fa-clock"></i> Awaiting Quote
                  </span>
                </div>
              {% endif %}
            </div>
          </div>
          
          <!-- Deadline Warning -->
          {% if job.hard_deadline %}
            <div class="alert alert-danger py-2 mb-3">
              <small>
                <i class="fas fa-exclamation-triangle"></i>
                Due {{ job.hard_deadline.strftime('%m/%d/%Y') if job.hard_deadline.strftime else job.hard_deadline }}
              </small>
            </div>
          {% endif %}
          
          <!-- Job ID -->
          <div class="text-center">
            <small class="text-muted">Job #{{ job.id }}</small>
          </div>
        </div>
        
        <!-- Card Footer with Actions -->
        <div class="card-footer bg-light">
          <div class="row g-1">
            <div class="col-6">
              <a href="{{ url_for('job_details', job_id=job.id) }}" 
                 class="btn btn-primary btn-sm w-100">
                <i class="fas fa-eye"></i> View
              </a>
            </div>
            <div class="col-6">
              <a href="{{ url_for('edit_job', job_id=job.id) }}" 
                 class="btn btn-outline-warning btn-sm w-100">
                <i class="fas fa-edit"></i> Edit
              </a>
            </div>
          </div>
          <div class="row g-1 mt-1">
            <div class="col-6">
              <a href="{{ url_for('job_gallery', job_id=job.id) }}" 
                 class="btn btn-outline-info btn-sm w-100">
                <i class="fas fa-images"></i> Gallery
              </a>
            </div>
            <div class="col-6">
              <form action="{{ url_for('delete_job', job_id=job.id) }}" 
                    method="POST" 
                    style="display: inline" 
                    onsubmit="return confirm('Delete job for {{ job.client_name }}?');">
                <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  {% else %}
    <div class="col-12">
      <div class="card">
        <div class="card-body text-center py-5">
          <i class="fas fa-briefcase fa-3x text-muted mb-3"></i>
          <h4 class="text-muted">No Jobs Found</h4>
          <p class="text-muted">Create your first cabinet project to get started!</p>
          <a href="{{ url_for('home') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Create New Job
          </a>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<!-- Back to Planner -->
<div class="row mt-4">
  <div class="col-12 text-center">
    <a href="{{ url_for('home') }}" class="btn btn-secondary">
      <i class="fas fa-arrow-left"></i> Back to Planner
    </a>
  </div>
</div>

<script>
// Search and Filter Functionality
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('searchInput');
  const statusFilter = document.getElementById('statusFilter');
  const priceFilter = document.getElementById('priceFilter');
  
  function filterJobs() {
    const searchTerm = searchInput.value.toLowerCase();
    const statusValue = statusFilter.value;
    const priceRange = priceFilter.value;
    
    document.querySelectorAll('.job-card').forEach(card => {
      let show = true;
      
      // Search filter
      if (searchTerm) {
        const clientName = card.dataset.client || '';
        if (!clientName.includes(searchTerm)) {
          show = false;
        }
      }
      
      // Status filter
      if (statusValue && card.dataset.status !== statusValue) {
        show = false;
      }
      
      // Price filter
      if (priceRange) {
        const price = parseFloat(card.dataset.price) || 0;
        const [min, max] = priceRange.split('-').map(p => parseFloat(p.replace('+', '')) || Infinity);
        if (price < min || (max !== Infinity && price > max)) {
          show = false;
        }
      }
      
      card.style.display = show ? 'block' : 'none';
    });
  }
  
  // Event listeners
  searchInput.addEventListener('input', filterJobs);
  statusFilter.addEventListener('change', filterJobs);
  priceFilter.addEventListener('change', filterJobs);
});

function clearFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('statusFilter').value = '';
  document.getElementById('priceFilter').value = '';
  
  document.querySelectorAll('.job-card').forEach(card => {
    card.style.display = 'block';
  });
}
</script>

{% endblock %}
