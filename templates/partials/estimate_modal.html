<!-- Estimate Modal -->
<div class="modal fade" id="estimateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <!-- enctype to allow image uploads -->
      <form
        method="POST"
        action="{{ url_for('save_estimate', job_id=job.id) }}"
        id="estimateForm"
        enctype="multipart/form-data"
      >
        <div class="modal-header">
          <h5 class="modal-title">ðŸ’° Estimate Cost</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>

        <div class="modal-body">
          <!-- Core fields -->
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Linear Feet</label>
              <input
                type="number"
                step="any"
                class="form-control est-num"
                id="lf"
                placeholder="e.g. 24"
              />
              <div class="form-text">Ã— $150 automatically</div>
            </div>

            <div class="col-12"><hr class="my-2" /></div>

            <!-- Drawer Slides -->
            <div class="col-md-4">
              <label class="form-label">Drawer Slides (Model)</label>
              <input
                type="text"
                class="form-control"
                id="slides_model"
                placeholder="e.g. Blum 563"
              />
            </div>
            <div class="col-md-2">
              <label class="form-label">Qty</label>
              <input
                type="number"
                step="1"
                min="0"
                class="form-control est-num"
                id="slides_qty"
                placeholder="0"
              />
            </div>
            <div class="col-md-3">
              <label class="form-label">Unit Price</label>
              <input
                type="number"
                step="any"
                class="form-control est-num"
                id="slides_unit"
                placeholder="e.g. 20"
              />
            </div>

            <!-- Hinges -->
            <div class="col-md-4">
              <label class="form-label">Hinges (Model)</label>
              <input
                type="text"
                class="form-control"
                id="hinges_model"
                placeholder="e.g. Compact 38N"
              />
            </div>
            <div class="col-md-2">
              <label class="form-label">Qty</label>
              <input
                type="number"
                step="1"
                min="0"
                class="form-control est-num"
                id="hinges_qty"
                placeholder="0"
              />
            </div>
            <div class="col-md-3">
              <label class="form-label">Unit Price</label>
              <input
                type="number"
                step="any"
                class="form-control est-num"
                id="hinges_unit"
                placeholder="e.g. 2"
              />
            </div>

            <div class="col-12"><hr class="my-2" /></div>

            <!-- Laminate Sheet -->
            <div class="col-md-3">
              <label class="form-label">Laminate Sheets (Qty)</label>
              <input
                type="number"
                step="1"
                min="0"
                class="form-control est-num"
                id="lam_qty"
                placeholder="0"
              />
            </div>
            <div class="col-md-3">
              <label class="form-label">Laminate Sheet Unit $</label>
              <input
                type="number"
                step="any"
                class="form-control est-num"
                id="lam_unit"
                placeholder="e.g. 25"
              />
            </div>

            <!-- Top Counter Laminate -->
            <div class="col-md-3">
              <label class="form-label">Top Counter (Qty)</label>
              <input
                type="number"
                step="1"
                min="0"
                class="form-control est-num"
                id="top_qty"
                placeholder="0"
              />
            </div>
            <div class="col-md-3">
              <label class="form-label">Top Counter Unit $</label>
              <input
                type="number"
                step="any"
                class="form-control est-num"
                id="top_unit"
                placeholder="e.g. 150"
              />
            </div>

            <!-- Install Fee -->
            <div class="col-md-3">
              <label class="form-label">Install Fee</label>
              <input
                type="number"
                step="any"
                class="form-control est-num"
                id="install_fee"
                placeholder="e.g. 300"
              />
            </div>
          </div>

          <hr class="my-4" />

          <!-- Accessories -->
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h6 class="mb-0">Accessories</h6>
            <button
              class="btn btn-sm btn-outline-primary"
              id="btnAddAccessory"
              type="button"
            >
              âž• Add Accessory
            </button>
          </div>
          <div id="accessoriesWrap" class="vstack gap-2"></div>

          <template id="tplAccessoryRow">
            <div class="card card-body p-2 border">
              <div class="row g-2 align-items-end">
                <div class="col-md-4">
                  <label class="form-label mb-0">Name / Model</label>
                  <input
                    type="text"
                    class="form-control acc-name"
                    name="acc_name[]"
                    placeholder="e.g. Pull #BP53005"
                  />
                </div>
                <div class="col-md-2">
                  <label class="form-label mb-0">Qty</label>
                  <input
                    type="number"
                    step="1"
                    min="0"
                    class="form-control acc-qty"
                    name="acc_qty[]"
                    placeholder="0"
                  />
                </div>
                <div class="col-md-3">
                  <label class="form-label mb-0">Unit $</label>
                  <input
                    type="number"
                    step="any"
                    class="form-control acc-unit"
                    name="acc_unit[]"
                    placeholder="e.g. 4.50"
                  />
                </div>
                <div class="col-md-3">
                  <label class="form-label mb-0">Image (optional)</label>
                  <input
                    type="file"
                    class="form-control acc-img"
                    name="acc_image[]"
                    accept="image/*"
                  />
                </div>
                <div class="col-md-12 text-end">
                  <button
                    type="button"
                    class="btn btn-outline-danger btnRemoveRow"
                  >
                    âœ– Remove
                  </button>
                </div>
              </div>
            </div>
          </template>

          <hr class="my-4" />

          <!-- Commissions -->
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h6 class="mb-0">Commissions</h6>
            <button
              class="btn btn-sm btn-outline-primary"
              id="btnAddCommission"
              type="button"
            >
              âž• Add Commission
            </button>
          </div>
          <div id="commissionsWrap" class="vstack gap-2"></div>

          <template id="tplCommissionRow">
            <div class="card card-body p-2 border">
              <div class="row g-2 align-items-end">
                <div class="col-md-7">
                  <label class="form-label mb-0">Name</label>
                  <input
                    type="text"
                    class="form-control com-name"
                    name="com_name[]"
                    placeholder="e.g. Sales, Referral"
                  />
                </div>
                <div class="col-md-5">
                  <label class="form-label mb-0">Amount</label>
                  <input
                    type="number"
                    step="any"
                    class="form-control com-amount"
                    name="com_amount[]"
                    placeholder="e.g. 200"
                  />
                </div>
                <div class="col-md-12 text-end">
                  <button
                    type="button"
                    class="btn btn-outline-danger btnRemoveRow"
                  >
                    âœ– Remove
                  </button>
                </div>
              </div>
            </div>
          </template>

          <hr class="my-4" />

          <!-- Summary -->
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="small text-muted">Calculated Total</div>
              <div class="fs-4 fw-bold" id="calcTotal">$0.00</div>
            </div>
            <!-- still post only amount to backend -->
            <input type="hidden" name="amount" id="est_amount" value="0" />
            <div class="d-flex gap-2">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button type="button" class="btn btn-outline-dark" id="btnCalc">
                Calculate
              </button>
              <button type="submit" class="btn btn-success">
                Save Estimate
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  (function () {
    const $ = (s, r = document) => r.querySelector(s);
    const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
    const num = (v) => {
      const n = parseFloat(v);
      return Number.isFinite(n) ? n : 0;
    };

    const accessoriesWrap = $("#accessoriesWrap");
    const commissionsWrap = $("#commissionsWrap");
    const tplAcc = $("#tplAccessoryRow");
    const tplCom = $("#tplCommissionRow");
    const amountInput = $("#est_amount");
    const totalEl = $("#calcTotal");

    function addRow(tpl, target) {
      const node = tpl.content.firstElementChild.cloneNode(true);
      node.querySelector(".btnRemoveRow").addEventListener("click", () => {
        node.remove();
        calc();
      });
      // recalc on any number change inside the node
      node.addEventListener("input", (e) => {
        if (e.target.matches('input[type="number"]')) calc();
      });
      target.appendChild(node);
    }

    $("#btnAddAccessory").addEventListener("click", () =>
      addRow(tplAcc, accessoriesWrap)
    );
    $("#btnAddCommission").addEventListener("click", () =>
      addRow(tplCom, commissionsWrap)
    );

    // Start with one row each (optional)
    addRow(tplAcc, accessoriesWrap);
    addRow(tplCom, commissionsWrap);

    function calc() {
      // Linear feet * 150
      let total = num($("#lf").value) * 150;

      // Slides: qty * unit
      total += num($("#slides_qty").value) * num($("#slides_unit").value);

      // Hinges: qty * unit
      total += num($("#hinges_qty").value) * num($("#hinges_unit").value);

      // Laminate sheets and top counters: qty * unit
      total += num($("#lam_qty").value) * num($("#lam_unit").value);
      total += num($("#top_qty").value) * num($("#top_unit").value);

      // Install fee
      total += num($("#install_fee").value);

      // Accessories rows: qty * unit
      $$(".acc-qty").forEach((qtyInput, i) => {
        const unit = $$(".acc-unit")[i];
        total += num(qtyInput.value) * num(unit.value);
      });

      // Commissions: sum of amounts
      $$(".com-amount").forEach((i) => (total += num(i.value)));

      amountInput.value = total.toFixed(2);
      totalEl.textContent = `$${total.toFixed(2)}`;
    }

    // live recalculation for top-level numeric inputs
    $$(".est-num").forEach((i) => i.addEventListener("input", calc));
    $("#btnCalc").addEventListener("click", calc);
  })();
</script>
